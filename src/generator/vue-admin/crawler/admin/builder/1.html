<script type="text/javascript">

        console.log("into script")
        $(() => {
                $('#mainForm').validate(
                        {
                                errorClass: "error",
                                focusInvalid: true,
                                submitHandler: async function (form) {
                                        try {
                                                getData();
                                                let resp = await post();
                                                alert(resp.Message);
                                                return resp.Status;
                                        } catch (ex) {
                                                console.log(ex);
                                                alert("操作失败");
                                        }

                                        return false;
                                }
                        }
                )
        })


        // 数据模型
        var data = {
                ProductId: null,
                FirstChargeFace: null,
                RewardCntr: null,
                RewardType: null,
                RewardMonth: null,
                RewardDetail: null, // 10|10|20|10
                Status: null,
        };

        // 默认期数选项
        var allowedRewardCount = new Set([1, 6, 12, 24]);

        // 当前是否 自定义期数模式
        var customerRewardCountMode = false;


        // 绑定事件
        $(() => {
                // 需要首充 checkbox
                $("#firstChargeFaceToggler").change((target) => {
                        debugger
                        if ($("#firstChargeFaceToggler").attr("checked")) {
                                $("#firstChargeFace").hide();
                                needCharge = false;
                        } else {
                                $("#firstChargeFace").show();
                                needCharge = true;
                        }
                });

                // 自定义期数 checkbox
                $("#rewardCountToggle").change((target) => {
                        if ($("#rewardCountToggle").attr("checked")) {
                                $("#defaultRewardCoutContainer").hide();
                                $("#customerCountContainer").show();
                                customerRewardCountMode = true;
                        } else {
                                $("#defaultRewardCoutContainer").show();
                                $("#customerCountContainer").hide();
                                customerRewardCountMode = false;
                        }
                });

                // sumit click 自定义期数
                $("#customerRewardCountBtn").click(() => {
                        debugger
                        changeRewardCount($("#customerRewardCount").val())
                });


        });

        // 更新 reward count
        function changeRewardCount(count) {
                count = parseFloat(count);
                if (!count) {
                        alert("请输入正确的佣金次数");
                        return;
                }

                let detail = "";
                for (let i = 0; i < count; i++) {
                        detail += "0|";
                }

                if(detail.endsWith("|"))
                  detail =detail.substr(0,detail.length-1);
                renderRewardDetail(detail);
        }

        function onRewardRadioChanged(target,count){
             if($(target).attr("checked"))
                changeRewardCount(count);
          
        }


        // 渲染 detail table
        function renderRewardDetail(detail) {
                let values = [];
                detail.split("|").forEach(x => {
                        values.push(parseFloat(x));
                });
                var content = `<table style="border: 1px solid; text-align: center;border-collapse: collapse;" width="100%" border="1" cellpadding="0" cellspacing="0"><thead><tr>${renderTableHeader(values.length)}</tr></thead><tbody style="text-align:left;"><tr>${renderTableRow(values)}</tr></tbody>`;

                $("#rewardItemsContainer").empty();
                $("#rewardItemsContainer").append($(content));

        }

        // 渲染 header
        function renderTableHeader(count) {
                var content = "";
                for (let i = 0; i < count; i++) {
                        content += `<th>T+${i+1}期</th>`;
                }
                return content;
        }

        // 渲染 body
        function renderTableRow(values) {
                var content = "";
                values.forEach(x => {
                        content += `<td><input class="detail_value" type="text" style="border:none;padding:6px;" value="${x}"/></td>`
                })
                return content;
        }

        // 选择单选按钮  
        function chooseRadio(prefix, value) {
                $(`#${prefix}_${value}`).attr("checked", true);
        }

        // 初始化页面
        function init() {
               
                $("#firstChargeFace").val(data.FirstChargeFace);
                
                // 佣金类型
                chooseRadio("reward_type", data.RewardType);

                // 设置 佣金月类型
                chooseRadio("month_type", data.RewardMonth);

                // 佣金次数
                if (!(data.RewardCntr &&allowedRewardCount.has(data.RewardCntr))) {
                        customerRewardCountMode = true;
                        $("#defaultRewardCoutContainer").hide();
                        $("#rewardCountToggle").attr("checked",true);
                        $("#customerCountContainer").show();
                        $("#customerRewardCount").val(data.RewardCntr);
                } else {
                        customerRewardCountMode = false;
                        $("#defaultRewardCoutContainer").show();
                        $("#rewardCountToggle").removeAttr("checked");
                        $("#customerCountContainer").hide();
                      
                         chooseRadio("reward_count", data.RewardCntr);
                }

                // 设置状态选择
                if (data.Status == 0) {
                        $("#status").attr("checked", true);
                }

                if(data.RewardDetail){
                     if(data.RewardDetail.endsWith("|"))
                       data.RewardDetail=data.RewardDetail.substr(0,data.RewardDetail.length-1);
                                 renderRewardDetail(data.RewardDetail);
                }

               
        }

        // 获取提交数据并检查
        function getData() {
               
               data.FirstChargeFace = $("#firstChargeFace").val();
               checkNumber(data.FirstChargeFace, "首充面值不正确");
                

             //   data.RewardType = getRadioValue("reward_type", [1, 2]);
                data.RewardMonth = getRadioValue("month_type", [0, 1, 2, 3]);
                data.RewardCntr = getRewardCount();
                checkNumber(data.RewardCntr, "期数不正确");
                data.RewardDetail = getRewardDetail();
                data.Status = getStatus();
        }

        // 获取期数
        function getRewardCount() {
                if (customerRewardCountMode) {
                        return $("#customerRewardCount").val();
                } else {
                        return getRadioValue("reward_count", [1, 6, 12, 24]);
                }
        }

        // 获取选中单选按钮的值
        function getRadioValue(type, values) {
                for (const value of values) {
                        if ($(`#${type}_${value}`).attr("checked"))
                                return value;
                }

                throw new Error("unexcepted result");
        }

        // 获取期数详情
        function getRewardDetail() {
                detail = "";
                $(".detail_value").each((i, x) => {
                        let value = $(x).val();
                        checkNumber(value, `第${i+1}期数值不正确`);
                        detail += `${value}|`;
                })

                 if(detail.endsWith("|"))
                  detail =detail.substr(0,detail.length-1);

                return detail;
        }

        // 获取状态值
        function getStatus() {
                if ($("#status").attr("checked"))
                        return 0;

                return 1;
        }

        // 检查是否是正确的数字
        function checkNumber(value, msg) {
                value = parseFloat(value);
                if (isNaN(value)) {
                        alert(msg);
                        throw new Error();
                }
        }

        // post
        function post() {
                return new Promise((resolve, rejetct) => {
                        $.ajax({
                                url: "/FCDownProduct/AddOrUpdateRewardRule",
                                type: "post",
                                dataType: "json",
                                contentType: 'application/json',
                                data: JSON.stringify(data),
                                success: resp => resolve(resp),
                                error: err => rejetct(err)
                        });
                });
        }

        // init
        $(() => {
                debugger
                data = $.parseJSON($("#data").val());
                init();
        })

</script>
<style>
 .detail_value 
 {
     max-width:65px;
     }
</style>
<form id="mainForm" method="post">
        <input type="hidden" id="data" value="@ViewBag.Data" />
        <table>
                <tr>
                        <td>首充面值</td>
                        <td>
                                <input style="line-height: 22px;" type="text" id="firstChargeFace" /><span style="color:red; margin-left:10px;">0代表不首充</span>
                        </td>
                </tr>
     @*           <tr>
                        <td>佣金类型</td>
                        <td>
                                <input type="radio" name="reward_type" id="reward_type_1" /><label for="reward_type1">定额</label>
                                <input type="radio" name="reward_type" id="reward_type_2" /><label for="reward_type2">比例</label>
                        </td>
                </tr>*@
                <tr>
                        <td>首赠月份</td>
                        <td>
                                <input type="radio" id="month_type_0" name="month_type" /><label for="month_type_0">当月</label>
                                <input type="radio" id="month_type_1" name="month_type"/><label for="month_type_1">次月</label>
                                <input type="radio" id="month_type_2" name="month_type"/><label for="month_type_2">第二月</label>
                                <input type="radio" id="month_type_3" name="month_type" /><label for="month_type_3">第三月</label>
                        </td>
                </tr>
                <tr>
                        <td>赠送次数</td>
                        <td>
                                <span id="defaultRewardCoutContainer">
                                        <input type="radio" name="reward_count" id="reward_count_1"
                                                onchange="onRewardRadioChanged(this,1)" /><label
                                                for="reward_count_1">1期</label>
                                        <input type="radio"  name="reward_count" id="reward_count_6"
                                                onchange="onRewardRadioChanged(this,6)" /><label
                                                for="reward_count_6">6期</label>
                                        <input type="radio"  name="reward_count" id="reward_count_12"
                                                onchange="onRewardRadioChanged(this,12)" /><label
                                                for="reward_count_12">12期</label>
                                        <input type="radio"  name="reward_count" id="reward_count_24"
                                                onchange="onRewardRadioChanged(this,24)" /><label
                                                for="reward_count_24">24期</label>
                                </span>

                                <span><input type="checkbox" id="rewardCountToggle" />自定义</span>
                                <span id="customerCountContainer">
                                        <input type="text" style="line-height: 22px;" id="customerRewardCount" />
                                        <button type="button" style="padding: 3px;" id="customerRewardCountBtn">修改期数</button>
                                </span>
                        </td>
                </tr>
                <tr>
                        <td>资费详情</td>
                        <td>
                                <div id="rewardItemsContainer" style="overflow-x: auto;max-width: 800px;padding: 15px;"></div>
                        </td>
                </tr>
                <tr>
                        <td>状态</td>
                        <td>
                                <input type="checkbox" id="status" />
                        </td>
                </tr>

        </table>
</form>