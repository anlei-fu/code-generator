@model SuperTiny.Entity.MSTCarrierProductShelf
@using MatchingRecharge.UserService;
@using SuperTiny.UserService;
@using SuperTiny.Entity;
@{
    Layout = null;
}
<link href="/Content/jquery.select.debug.css" rel="stylesheet" type="text/css" />
<script src="/Scripts/plugin.chinese.to.pinyin.js" type="text/javascript"></script>
<script src="/Scripts/jquery.select.debug.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function () {
        $("#mainForm").find('select').sSelect();
        $('#mainForm').validate({
            errorClass: "error",
            focusInvalid: true,
            submitHandler: function (form) {
                if (isBatchEdit&&!getAndCheckProductIds()) {
                    alert("产品面值未配置或不正确");
                    return;
                }
                return saveLocalShelf();
            },
            rules: {
                cost: { required: true, range: [0, 1] },
                realcost: { required: true, range: [0, 1] },
                CCount: { required: true, digits: true },
                uppface: { digits: true }
            },
            messages: {}
        });
    });

    // init
    $(function () {
        // 编辑情况隐藏
        if ($("__id").val()) {
            $("#batch-add-product").hide();
        }
    });

    // cache{ {bussinessNo:[product]}...}
    var products={};
    var isBatchEdit = false;

    // toggle batch and sigle mode
    function batchEditCheckChanged(show) {
        if (show) {
            isBatchEdit = true;
            $("#edit-container").show();
            $("#single").hide();
            renderBatchAdd();
        } else {
            isBatchEdit = false;
            $("#edit-container").hide();
            $("#single").show();
            $("#product-container").val("");
        }
    }

    /*
     * 渲染 product by bussiness no
     *
     */
    var all = "<input style='margin-left:10px;' type='checkbox' onchange='selectAllProduct(this.checked)'>全部";
    var template = `<input style='margin-left:5px;' 
                            type='checkbox' id='#productCheck'
                            onchange='changeProductVisibility("#productNo",this.checked)' />
                     #productName
                    <input style="display:none;width:20px;" 
                           type='text'  
                           id='#productNo' width="50px" readonly="#readonly" value="#face" />`;
    function renderBatchAdd() {
        console.log("into render batch");
        if (!isBatchEdit)
            return;
        
        var bsussinessNo=$("bno").val();
        if(!bussinessNo)
           return;
        
        console.log(`bussinessNo:${bussinessNo}`);

        // fetach
        if(!products[bussinessNo]&&!getProducts(bussinessNo))
              return;

        $("#edit-container").empty();
        $("#edit-container").append(all);

         products[bsussinessNo].forEach(product=>{
             console.log(product.ProductName);
             var item = template.replace(/#productName/, product.ProductName)
                                .replace(/#productNo/g, product.ProductNo)
                                .replace(/#face/,product.Face);

            $("#edit-container").append(item);
         });
    }
    
    // 查询产品
    function getProducts(bussinessNo){
        var success=false;
        $.ajax({
            url:"",
            type:"post",
            async:false,
            success:resp=>{

            },
            error:error=>{
                   alert("查询产品失败");
                   success=false;
            }
        });
        
        return success;
    }

    /**
    *设置面值输入框 可见性
    */
    function changeProductVisibility(id, show) {
        console.log(id);
        if (!show) {
            $("#" + id).hide();
        } else {
            $("#" + id).show();
        }

        getAndCheckProductIds();
    }

    /**
    *  check box changed ,resave all products
    *  检查面值是否正确，并且保存到 input hidden 控件上
    */
    function getAndCheckProductIds() {
        var batchAddValidatePassed = true;
        var products = "";
        $("#edit-container input[type=checkbox]").each(function () {
            if ($(this).is(":checked")) {

                // exclude all
                var productId = $(this).attr("id").replace("Check", "");
                if (!productId)
                    return;

                var face = $("#" + productId).val();
                face = parseFloat(face);
                console.log(`product :${productId}, face :${face}`);
                if (isNaN(face)||face<0) {
                    batchAddValidatePassed = false;
                    return;
                }

                products += `${productId}|${face}`;
            }
        });

        $("#product-container").val(products);
        console.log(products);
        console.log("check result");
        console.log(batchAddValidatePassed);

        return batchAddValidatePassed;
    }


    /**
    * 全选回调
    */
    function selectAllProduct(checked) {
        $("#edit-container input[type=checkbox]").attr("checked", checked);
        if (checked) {
            $("#edit-container input").show();
        } else {
            $("#edit-container :text").hide();
        }
    }
</script>
<form id="mainForm" method="post">
  @if (Model.ShelfNo == null)
  {
<input type="hidden" name="products" id="product-container" />
  }
<table>
    <tr>
        <td width="120" class="textalign_r">
            <em class="required">*</em>渠道名称：
        </td>
        <td width="200" class="textalign_l">
            @if (Model.ShelfNo == null)
            {
                @Html.DropDownList("cno", new SelectList(UpChannelService.Instance.GetUpChannelList(), "ChannelNo", "ChannelName", Model.UpChannelNo), new { style = "width:128px" })
            }
            else
            {
                @Model.ChannelName
                <input type="hidden" name="ShelfNo" value="@Model.ShelfNo" />
            }
        </td>
        <td width="120" class="textalign_r">
            <em class="required">*</em>业务名称：
        </td>
        <td width="200" class="textalign_l">
            @if (Model.ShelfNo == null)
            {
                @Html.DropDownList("bno", new SelectList(ViewBag.BussinessList, "BusinessNo", "BusinessName", Model.BusinessNo), new { style = "width:128px", onchange = "changeBussiness(this);" })
            }
            else
            {
                @Model.BusinessName
            }
        </td>
    </tr>
    <tr>
        <td width="120" class="textalign_r">
            <em class="required">*</em>省份：
        </td>
        <td width="200" class="textalign_l">
            @Html.DropDownList("province", new SelectList(SystemProvinceService.Instance.GetProvinceList(), "ProvinceID", "ProvinceName", Model.ProvinceNo), new { style = "width:128px" })
        </td>
       
    </tr>
    <tr id="single">
        <td width="120" class="textalign_r">
            支持产品：
        </td>
        <td width="200" class="textalign_l">
            @Html.DropDownList("providepno", new SelectList(ViewBag.ProductList, "ProductNo", "ProductName", Model.CarrierProductNo), "*", new { style = "width:128px",  })
        </td>
          <td width="120" class="textalign_r">
            上游产品面值：
        </td>
        <td width="200" class="textalign_l">
            <input type="text" name="uppface" class="widthinput" value="@Model.UpProductFace" maxlength="7" />
        </td>
    </tr>
      @if (Model.ShelfNo == null)
      {
    <tr id="batch-add-product">
        <td>
            <input type="checkbox" id="batch-add" onchange="batchEditCheckChanged(this.checked)" />
            批量添加（(产品：面值)）：
        </td>
        <td>
            <div id="edit-container">
            </div>
        </td>
    </tr>
      }
    <tr height="">
        <td width="120" class="textalign_r">
            排除产品：
        </td>
        <td width="200" class="textalign_l">
            <div id="divExtProduct">
                @foreach (SuperTiny.Entity.MSTCarrierProducts item in ViewBag.ProductList)
                {
                    <input type="checkbox" name="extpno" value="@item.ProductNo" @((Model.ExcProductNo != null && Model.ExcProductNo.IndexOf("|" + item.ProductNo + "|") >= 0) ? "checked='checked'" : "") /><span>@item.ProductName</span> 
                }
            </div>
        </td>
        <td width="120" class="textalign_r">
            上游产品编号：
        </td>
        <td width="200" class="textalign_l">
            <input type="text" name="uppno" class="widthinput" value="@Model.UpProductNo" maxlength="200" />
        </td>
    </tr>
    <tr height="30">
      
        <td width="120" class="textalign_r">
            <em class="required">*</em>扣款折扣：
        </td>
        <td width="200" class="textalign_l">
            <input type="text" name="cost" class="widthinput" value="@Model.CostDiscount" maxlength="13" />
        </td>
    </tr>
    <tr height="30">
        <td width="120" class="textalign_r">
            <em class="required">*</em>实际折扣：
        </td>
        <td width="200" class="textalign_l">
            <input type="text" name="realcost" class="widthinput" value="@Model.RealDiscount" maxlength="13" />
        </td>
        <td width="120" class="textalign_r">
            <em class="required">*</em>同时充值张数：
        </td>
        <td width="200" class="textalign_l">
            <input type="text" name="MinCount" class="widthinput" value="@Model.MinCount" maxlength="6" style="width:50px" />
            ~
            <input type="text" name="CCount" class="widthinput" value="@Model.CardCount" maxlength="6" style="width:50px"  />
        </td>
    </tr>
    <tr height="30">
        <td width="120" class="textalign_r">
            <em class="required">*</em>状态：
        </td>
        <td width="200" class="textalign_l">
            <input type="checkbox" name="status" value="0" @(Model.Status == EnableStatus.Enable ? "checked='checked'" : "") />
        </td>
        <td width="120" class="textalign_r">
            <em class="required">*</em> 扣款方式：
        </td>
        <td width="200" class="textalign_l">
            <select name="ChargebackType">
                @foreach (var item in (DataService.Instance.GetDataList(typeof(SuperTiny.Entity.ChargeBackType))))
                {
                    <option  value=@item.Value  @(((int?)Model.ChargebackType).ToString() == item.Value ? "selected=selected" : "")>@item.Name</option>
                }
            </select>
            @*  @Html.DropDownList("ChargebackType", new SelectList(DataService.Instance.GetDataList(typeof(SuperTiny.Entity.ChargeBackType)), "value", "name", Convert.ToInt32(Model.ChargebackType)))*@
        </td>
    </tr>
    <tr height="30">
        <td width="120" class="textalign_r">
            是否需要指定下游：
        </td>
        <td width="200" class="textalign_l">
            <input type="checkbox" name="IsSpecifyDown" value="0" @(Model.IsSpecifyDown == 0 ? "checked=checked" : "")/>
        </td>
        <td width="120" class="textalign_r">
            <em class="required">*</em>前后项：
        </td>
        <td width="200" class="textalign_l">
            @Html.DropDownList("BillType", new SelectList(MatchingRecharge.UserService.DataService.Instance.GetDataList("BillType"), "value", "name"), Model.BillType)
        </td>
    </tr>
</table>
</form>
